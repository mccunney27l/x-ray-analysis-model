import React, { useState, useCallback } from 'react';
import { BeakerIcon, RotateCw, AlertTriangle } from 'lucide-react';

// Firebase global variables are not used since this is a single-user simulation without persistence.

// Define the API configuration constants
const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";
const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=`;
const API_KEY = ""; // Placeholder for Canvas runtime injection

// Utility function to convert File to Base64
const fileToBase64 = (file) => {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
    });
};

// Component for the main application
const App = () => {
    const [selectedFile, setSelectedFile] = useState(null);
    const [base64Image, setBase64Image] = useState(null);
    const [analysisResult, setAnalysisResult] = useState(null);
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState(null);

    // --- State and Handlers ---

    // Handles file selection and conversion to Base64
    const handleFileChange = async (event) => {
        const file = event.target.files[0];
        if (file && file.type.startsWith('image/')) {
            setSelectedFile(file);
            try {
                const base64 = await fileToBase64(file);
                setBase64Image(base64);
                setAnalysisResult(null); // Clear previous results
                setError(null);
            } catch (err) {
                console.error("Error converting file to base64:", err);
                setError("Could not load image file.");
                setBase64Image(null);
                setSelectedFile(null);
            }
        } else if (file) {
             setError("Please select a valid image file (PNG, JPG).");
             setSelectedFile(null);
             setBase64Image(null);
        }
    };

    // --- API and Analysis Logic ---

    // The core function to call the Gemini API for image analysis
    const analyzeImage = useCallback(async () => {
        if (!base64Image) {
            setError("Please upload an X-ray image first.");
            return;
        }

        setIsLoading(true);
        setError(null);
        setAnalysisResult(null);

        // System Instruction to guide the model's persona and output format
        const systemPrompt = "You are an educational AI tool designed to describe the visual characteristics of an X-ray image in simple, non-medical terms. You MUST include a disclaimer in bold at the start of your response. Focus on describing what the bone appears to be, and if there is a discontinuity or break line visible. Do not provide a formal medical diagnosis. Keep the description encouraging and educational.";
        
        // User Query to trigger the analysis
        const userQuery = "Please analyze this X-ray image. Describe the bone that appears to be shown and discuss any visible lines of fracture (e.g., 'a small break line,' 'a clear displacement,' 'no obvious break visible').";

        const payload = {
            contents: [{
                role: "user",
                parts: [
                    { text: userQuery },
                    {
                        inlineData: {
                            mimeType: selectedFile.type,
                            data: base64Image
                        }
                    }
                ]
            }],
            systemInstruction: {
                parts: [{ text: systemPrompt }]
            },
        };

        let result = null;
        let retries = 0;
        const maxRetries = 3;

        // Exponential backoff retry logic
        while (retries < maxRetries) {
            try {
                const response = await fetch(API_URL + API_KEY, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API call failed: ${errorData.error?.message || response.statusText}`);
                }

                result = await response.json();
                break; // Success, exit loop

            } catch (e) {
                retries++;
                if (retries >= maxRetries) {
                    console.error("Gemini API Error after multiple retries:", e);
                    setError("Failed to get analysis. Please try again.");
                } else {
                    const delay = Math.pow(2, retries) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        setIsLoading(false);

        if (result && result.candidates?.[0]?.content?.parts?.[0]?.text) {
            setAnalysisResult(result.candidates[0].content.parts[0].text);
        } else if (retries < maxRetries) {
            // Only set a generic error if the response was successful but missing expected content
            setError("Analysis completed but the model returned an empty response. Please try a different image.");
        }
    }, [base64Image, selectedFile]);


    // --- UI Rendering ---

    return (
        <div className="p-4 md:p-8 min-h-screen bg-gray-50 flex items-center justify-center">
            <div className="w-full max-w-3xl bg-white shadow-2xl rounded-2xl p-6 md:p-8 space-y-6">
                
                <header className="text-center pb-4 border-b border-indigo-100">
                    <h1 className="text-3xl font-extrabold text-indigo-700 flex items-center justify-center space-x-2">
                        <BeakerIcon className="w-8 h-8"/>
                        <span>X-Ray Analysis Simulator</span>
                    </h1>
                    <p className="text-gray-500 mt-2 text-sm">
                        An educational tool demonstrating AI image description.
                    </p>
                </header>

                {/* 1. UPLOAD SECTION */}
                <div className="space-y-4">
                    <label className="block text-lg font-medium text-gray-700">
                        Upload Your X-Ray Image (PNG or JPG)
                    </label>
                    <div className="flex flex-col sm:flex-row items-stretch sm:space-x-4 space-y-4 sm:space-y-0">
                        <input
                            type="file"
                            accept="image/png, image/jpeg"
                            onChange={handleFileChange}
                            className="flex-grow w-full file:mr-4 file:py-2 file:px-4
                                       file:rounded-full file:border-0
                                       file:text-sm file:font-semibold
                                       file:bg-indigo-50 file:text-indigo-700
                                       hover:file:bg-indigo-100
                                       p-2 border border-gray-300 rounded-lg"
                        />
                        <button
                            onClick={analyzeImage}
                            disabled={isLoading || !base64Image}
                            className={`px-6 py-3 text-white font-semibold rounded-full shadow-lg transition duration-300 transform 
                                       flex items-center justify-center space-x-2
                                       ${base64Image && !isLoading 
                                        ? 'bg-llm-primary hover:bg-indigo-600 active:scale-95' 
                                        : 'bg-gray-400 cursor-not-allowed'}`}
                        >
                            {isLoading ? (
                                <RotateCw className="w-5 h-5 animate-spin"/>
                            ) : (
                                <span className="text-lg">Analyze Image</span>
                            )}
                        </button>
                    </div>
                </div>

                {/* 2. IMAGE PREVIEW */}
                {base64Image && (
                    <div className="border border-indigo-200 rounded-xl p-4 bg-indigo-50/50">
                        <h2 className="text-xl font-bold text-indigo-700 mb-3">Image Preview</h2>
                        <div className="flex justify-center">
                             <img 
                                src={`data:${selectedFile.type};base64,${base64Image}`} 
                                alt="Uploaded X-Ray Preview" 
                                className="max-w-full h-auto max-h-80 object-contain rounded-lg shadow-md border border-gray-200"
                            />
                        </div>
                    </div>
                )}

                {/* 3. ERROR & WARNINGS */}
                {error && (
                    <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl flex items-start space-x-3 shadow-md">
                        <AlertTriangle className="w-5 h-5 flex-shrink-0 mt-0.5"/>
                        <p className="font-semibold">{error}</p>
                    </div>
                )}
                
                {/* 4. ANALYSIS RESULTS */}
                {analysisResult && (
                    <div className="bg-llm-light border border-llm-primary/50 rounded-xl p-6 shadow-xl">
                        <h2 className="text-2xl font-bold text-llm-primary mb-3 flex items-center space-x-2">
                            <BeakerIcon className="w-6 h-6"/>
                            <span>Simulated Educational Report</span>
                        </h2>
                        <div className="text-gray-700 leading-relaxed whitespace-pre-wrap">
                            {analysisResult}
                        </div>
                    </div>
                )}

                {/* Initial Disclaimer for empty state */}
                {!base64Image && !analysisResult && (
                     <div className="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded-xl flex items-start space-x-3 shadow-md">
                        <AlertTriangle className="w-5 h-5 flex-shrink-0 mt-0.5"/>
                        <p className="font-semibold">
                            Disclaimer: This tool provides a **simulated, educational description** of the image using AI. It is NOT a medical device and should NEVER replace a doctor's consultation.
                        </p>
                    </div>
                )}

            </div>
        </div>
    );
};

export default App;
